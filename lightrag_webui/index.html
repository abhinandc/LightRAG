<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LightRAG – Collections UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --radius:16px; --pad:14px; --gap:12px; --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    * { box-sizing: border-box; }
    body { font-family: var(--font); margin: 0; background: #0b1020; color: #eef2ff; }
    header { padding: 22px; display:flex; align-items:center; gap:16px; border-bottom: 1px solid #243054; background:#0f1530; position: sticky; top:0; z-index:10; }
    h1 { font-size: 18px; margin: 0; font-weight: 650; letter-spacing: .2px; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background: #111737; border: 1px solid #243054; border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
    .row { display: flex; flex-wrap: wrap; gap: var(--gap); align-items: center; }
    label { font-size: 13px; opacity:.9; }
    input[type="text"], input[type="url"], textarea, select {
      width: 100%; padding: var(--pad); border-radius: 12px; border: 1px solid #2b3560; background: #0d1330; color: #eef2ff;
    }
    textarea { min-height: 120px; resize: vertical; }
    .col { flex: 1 1 280px; }
    .btn {
      appearance: none; border: 1px solid #2b3560; background: #1a2150; color: #e6ecff;
      padding: 12px 14px; border-radius: 12px; cursor: pointer; font-weight: 600;
    }
    .btn:hover { background:#202a68; }
    .btn.secondary { background: transparent; }
    .muted { opacity: .8; font-size: 12px; }
    .pill { background:#19234f; padding:6px 10px; border-radius:999px; border:1px solid #2b3560; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .log { white-space: pre-wrap; background:#0a0f28; padding:14px; border-radius:12px; border:1px solid #243054; max-height: 320px; overflow:auto;}
    .tagbox { display:flex; gap:8px; flex-wrap:wrap; }
    .tagbox button { border:none; background:#1a2150; color:#a8b3ff; padding:6px 10px; border-radius:999px; cursor:pointer; }
    .tagbox button.active { background:#2a3aa0; color:#fff; }
    .right { margin-left:auto }
  </style>
</head>
<body>
  <header>
    <h1>LightRAG</h1>
    <span class="pill">Collections Enabled</span>
    <div class="right muted" id="baseInfo"></div>
  </header>

  <div class="container">
    <!-- Collection Picker -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Collection / Namespace</label>
          <select id="collectionSelect"></select>
        </div>
        <div class="col">
          <label>Add or rename collection</label>
          <input id="collectionInput" type="text" placeholder="e.g., admissions, sales, finance" />
        </div>
        <div class="col" style="flex:0 0 auto; display:flex; gap:8px; align-items:flex-end;">
          <button class="btn" id="addCollectionBtn">Add/Use</button>
          <button class="btn secondary" id="removeCollectionBtn">Remove</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        Tip: your last 8 collections are stored locally so you can switch fast.
      </div>
      <div class="tagbox" id="quickCollections" style="margin-top:10px"></div>
    </div>

    <!-- Ingest -->
    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Ingest</h2>
      <div class="grid">
        <div>
          <label>Source URL (optional)</label>
          <input id="sourceUrl" type="url" placeholder="https://example.com/file.pdf or s3://bucket/key" />
        </div>
        <div>
          <label>Local path (server-visible) or upload (choose one)</label>
          <input id="sourcePath" type="text" placeholder="/mnt/data/raw/admissions/2025-08-14/file.pdf" />
        </div>
        <div>
          <label>Metadata JSON (optional)</label>
          <textarea id="metadataJson" placeholder='{"doc_id":"my_doc_v1","tags":["factsheet"]}'></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="ingestBtn">POST /ingest</button>
        <span class="muted">Sends { namespace: &lt;collection&gt;, source_path/source_url, metadata }</span>
      </div>
      <div class="log" id="ingestLog" style="margin-top:12px"></div>
    </div>

    <!-- Query -->
    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Query</h2>
      <div class="grid">
        <div>
          <label>Your question</label>
          <textarea id="queryText" placeholder="Summarize key admissions deadlines and scholarship criteria."></textarea>
        </div>
        <div>
          <label>Filters (optional JSON)</label>
          <textarea id="filtersJson" placeholder='{"tags":["admissions","factsheet"]}'></textarea>
        </div>
        <div>
          <label>Retrieval options (optional JSON)</label>
          <textarea id="retrievalJson" placeholder='{"hybrid":true,"top_k":12,"mmr_lambda":0.4}'></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="queryBtn">POST /query</button>
        <span class="muted">Sends { namespace: &lt;collection&gt;, query, filters, retrieval }</span>
      </div>
      <div class="log" id="queryLog" style="margin-top:12px"></div>
    </div>

    <!-- Dashboard -->
    <div class="card" id="dashCard">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Dashboard</h2>
      <div class="grid" id="kpis">
        <div class="card" style="background:#0a0f28;">
          <div class="muted">Docs</div><div id="kpiDocs" style="font-size:24px;font-weight:700">-</div>
        </div>
        <div class="card" style="background:#0a0f28;">
          <div class="muted">Chunks</div><div id="kpiChunks" style="font-size:24px;font-weight:700">-</div>
        </div>
        <div class="card" style="background:#0a0f28;">
          <div class="muted">Graph Nodes</div><div id="kpiNodes" style="font-size:24px;font-weight:700">-</div>
        </div>
        <div class="card" style="background:#0a0f28;">
          <div class="muted">Graph Edges</div><div id="kpiEdges" style="font-size:24px;font-weight:700">-</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <canvas id="ingestSpark" height="60"></canvas>
      </div>
      <div class="tagbox" id="topTags" style="margin-top:8px"></div>
    </div>

    <!-- Filters -->
    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Filters</h2>
      <div class="grid">
        <div>
          <label>Title contains</label>
          <input id="fQ" type="text" placeholder="factsheet, handbook..." />
        </div>
        <div>
          <label>Tags (comma separated)</label>
          <input id="fTags" type="text" placeholder="admissions, scholarship" />
        </div>
        <div>
          <label>MIME</label>
          <input id="fMime" type="text" placeholder="application/pdf, text/plain" />
        </div>
        <div>
          <label>Date from</label>
          <input id="fFrom" type="date" />
        </div>
        <div>
          <label>Date to</label>
          <input id="fTo" type="date" />
        </div>
        <div>
          <label>Tag mode</label>
          <select id="fTagMode">
            <option value="AND">AND (all tags)</option>
            <option value="OR">OR (any tag)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="applyFiltersBtn">Apply</button>
        <button class="btn secondary" id="clearFiltersBtn">Clear</button>
        <span class="muted">Updates the document list & “Test query”.</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Actions</h2>
      <div class="row">
        <button class="btn" id="btnReindex">Reindex</button>
        <button class="btn" id="btnVacuum">Vacuum (dry run)</button>
        <button class="btn" id="btnExport">Export</button>
        <input id="delDocId" type="text" class="col" placeholder="doc_id to delete…" />
        <button class="btn" id="btnDeleteDoc">Delete Doc</button>
        <button class="btn right" id="btnTestQuery">Test Query (with filters)</button>
      </div>
      <div class="log" id="actionsLog" style="margin-top:12px"></div>
    </div>

    <!-- Documents -->
    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Documents</h2>
      <div class="row muted" style="margin-bottom:8px">
        <span id="docsSummary">—</span>
      </div>
      <div id="docsTable" class="log" style="background:#0a0f28"></div>
    </div>

  </div>

  <script>
    // ==== Config ====
    const API_BASE = window.LIGHTRAG_API_BASE || (document.currentScript.getAttribute('data-api') || '').trim() || '';
    const DEFAULT_COLLECTIONS = ["admissions", "sales", "finance"];
    const LS_KEY = "lightrag.collections.recent";
    const MAX_RECENTS = 8;

    // ==== DOM ====
    const $ = (id) => document.getElementById(id);
    const collectionSelect = $("collectionSelect");
    const collectionInput = $("collectionInput");
    const addCollectionBtn = $("addCollectionBtn");
    const removeCollectionBtn = $("removeCollectionBtn");
    const quickCollections = $("quickCollections");

    const ingestBtn = $("ingestBtn");
    const ingestLog = $("ingestLog");
    const sourceUrl = $("sourceUrl");
    const sourcePath = $("sourcePath");
    const metadataJson = $("metadataJson");

    const queryBtn = $("queryBtn");
    const queryLog = $("queryLog");
    const queryText = $("queryText");
    const filtersJson = $("filtersJson");
    const retrievalJson = $("retrievalJson");
    $("baseInfo").textContent = "API " + (API_BASE || "(same origin)");

    // ==== Collections state ====
    function loadCollections() {
      try {
        const saved = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        if (Array.isArray(saved) && saved.length) return saved.slice(0, MAX_RECENTS);
      } catch(e) {}
      return DEFAULT_COLLECTIONS.slice();
    }
    function saveCollections(list) {
      const uniq = Array.from(new Set(list.filter(Boolean).map(s => s.trim()).filter(s => s.length)));
      localStorage.setItem(LS_KEY, JSON.stringify(uniq.slice(0, MAX_RECENTS)));
      return uniq;
    }
    function setActiveCollection(name) {
      if (!name) return;
      const list = saveCollections([name, ...loadCollections()]);
      renderCollections(list, name);
    }
    function renderCollections(list, active) {
      collectionSelect.innerHTML = "";
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        if (name === active) opt.selected = true;
        collectionSelect.appendChild(opt);
      });
      // quick tags
      quickCollections.innerHTML = "";
      list.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        if (name === active) btn.classList.add("active");
        btn.onclick = () => setActiveCollection(name);
        quickCollections.appendChild(btn);
      });
    }

    // ==== Init ====
    const initial = loadCollections();
    renderCollections(initial, initial[0]);

    addCollectionBtn.onclick = () => {
      const name = (collectionInput.value || "").trim();
      const val = name || collectionSelect.value;
      if (!val) return;
      setActiveCollection(val);
      collectionInput.value = "";
    };

    removeCollectionBtn.onclick = () => {
      const current = collectionSelect.value;
      const list = loadCollections().filter(n => n !== current);
      const final = saveCollections(list);
      const fallback = final[0] || "";
      renderCollections(final, fallback);
    };

    // ==== Helpers ====
    function api(path) { return (API_BASE || "") + path; }
    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body),
      });
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch(e) { json = { raw:text }; }
      return { ok: res.ok, status: res.status, json };
    }
    function parseOptionalJSON(str) {
      const s = (str || "").trim();
      if (!s) return undefined;
      try { return JSON.parse(s); } catch(e) { throw new Error("Invalid JSON: " + e.message); }
    }
    function log(el, data) {
      const ts = new Date().toISOString();
      el.textContent = `[${ts}]\n` + (typeof data === "string" ? data : JSON.stringify(data, null, 2));
    }

    // ==== Actions ====
    ingestBtn.onclick = async () => {
      const ns = collectionSelect.value;
      const body = { namespace: ns };
      const srcUrl = (sourceUrl.value || "").trim();
      const srcPath = (sourcePath.value || "").trim();

      if (srcUrl) body.source_url = srcUrl;
      if (srcPath) body.source_path = srcPath;

      try {
        const meta = parseOptionalJSON(metadataJson.value);
        if (meta) body.metadata = meta;
      } catch(e) {
        log(ingestLog, "Metadata error: " + e.message);
        return;
      }

      log(ingestLog, {request: body});
      try {
        const out = await postJSON(api("/ingest"), body);
        log(ingestLog, out);
      } catch(e) {
        log(ingestLog, "Network/Server error: " + e.message);
      }
    };

    queryBtn.onclick = async () => {
      const ns = collectionSelect.value;
      const body = { namespace: ns, query: queryText.value || "" };

      try {
        const filters = parseOptionalJSON(filtersJson.value);
        if (filters) body.filters = filters;
      } catch(e) {
        log(queryLog, "Filters error: " + e.message);
        return;
      }
      try {
        const retr = parseOptionalJSON(retrievalJson.value);
        if (retr) body.retrieval = retr;
      } catch(e) {
        log(queryLog, "Retrieval error: " + e.message);
        return;
      }

      log(queryLog, {request: body});
      try {
        const out = await postJSON(api("/query"), body);
        log(queryLog, out);
      } catch(e) {
        log(queryLog, "Network/Server error: " + e.message);
      }
    };

    // ============ Dashboard/Filters/Actions ============
    
    const fQ = $("fQ"), fTags = $("fTags"), fMime = $("fMime"), fFrom = $("fFrom"), fTo = $("fTo"), fTagMode = $("fTagMode");
    const applyFiltersBtn = $("applyFiltersBtn"), clearFiltersBtn = $("clearFiltersBtn");
    const btnReindex = $("btnReindex"), btnVacuum = $("btnVacuum"), btnExport = $("btnExport"), btnDeleteDoc = $("btnDeleteDoc"), btnTestQuery = $("btnTestQuery");
    const delDocId = $("delDocId"), actionsLog = $("actionsLog");
    const docsTable = $("docsTable"), docsSummary = $("docsSummary");

    const kpiDocs = $("kpiDocs"), kpiChunks = $("kpiChunks"), kpiNodes = $("kpiNodes"), kpiEdges = $("kpiEdges"), topTags = $("topTags");

    async function fetchStats(ns) {
      const url = new URL(api("/stats"), window.location.origin);
      url.searchParams.set("namespace", ns);
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) throw new Error(`stats ${res.status}`);
      return res.json();
    }

    async function fetchDocs(ns, params = {}) {
      const url = new URL(api("/docs"), window.location.origin);
      url.searchParams.set("namespace", ns);
      Object.entries(params).forEach(([k,v]) => v && url.searchParams.set(k, v));
      const res = await fetch(url);
      if (!res.ok) throw new Error(`docs ${res.status}`);
      return res.json();
    }

    function renderKpis(s) {
      kpiDocs.textContent = s.docs ?? "-";
      kpiChunks.textContent = s.chunks ?? "-";
      kpiNodes.textContent = s.graph_nodes ?? "-";
      kpiEdges.textContent = s.graph_edges ?? "-";
      // tags
      topTags.innerHTML = "";
      (s.top_tags || []).slice(0, 12).forEach(([tag, n]) => {
        const b = document.createElement("button");
        b.textContent = `${tag} (${n})`;
        b.onclick = () => { fTags.value = fTags.value ? `${fTags.value},${tag}` : tag; applyFiltersBtn.click(); };
        topTags.appendChild(b);
      });
      // sparkline
      drawSparkline("ingestSpark", s.ingests_by_day || []);
    }

    // super light sparkline
    function drawSparkline(id, series) {
      const c = document.getElementById(id);
      if (!c || !series.length) { const ctx = c?.getContext?.("2d"); if (ctx) { ctx.clearRect(0,0,c.width,c.height);} return; }
      const ctx = c.getContext("2d");
      const w = c.width = c.clientWidth || 600, h = c.height;
      const values = series.map(x => x[1]);
      const max = Math.max(...values, 1), min = Math.min(...values, 0);
      ctx.clearRect(0,0,w,h);
      ctx.beginPath();
      series.forEach(([,v], i) => {
        const x = (i/(series.length-1)) * (w-10) + 5;
        const y = h - ((v - min) / (max - min || 1)) * (h-10) - 5;
        i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
      });
      ctx.strokeStyle = "#a8b3ff"; ctx.lineWidth = 2; ctx.stroke();
    }

    function currentFilterParams() {
      return {
        q: fQ.value.trim(),
        tags: fTags.value.trim(),    // csv
        mime: fMime.value.trim(),
        from: fFrom.value,
        to: fTo.value,
        tag_mode: fTagMode.value
      };
    }

    function renderDocsTable(resp) {
      const items = resp.items || [];
      docsSummary.textContent = `${items.length} of ${resp.total || items.length} documents`;
      const lines = items.map(it => {
        const t = (it.tags || []).join(", ");
        return `• ${it.doc_id} | ${it.title || "-"} | ${it.mime || "-"} | ${it.ingest_date || "-"} | [${t}]`;
      });
      docsTable.textContent = lines.join("\n") || "No documents match filters.";
    }

    async function refreshAllForNamespace(ns) {
      try {
        const stats = await fetchStats(ns);
        renderKpis(stats);
      } catch(e) { /* optional: show error */ }

      try {
        const docs = await fetchDocs(ns, currentFilterParams());
        renderDocsTable(docs);
      } catch(e) {
        docsTable.textContent = "Failed to fetch docs: " + e.message;
      }
    }

    // Wire collection change
    collectionSelect.addEventListener("change", () => {
      refreshAllForNamespace(collectionSelect.value);
    });
    // Initial load
    refreshAllForNamespace(collectionSelect.value);

    // Filters
    applyFiltersBtn.onclick = () => refreshAllForNamespace(collectionSelect.value);
    clearFiltersBtn.onclick = () => { fQ.value = fTags.value = fMime.value = fFrom.value = fTo.value = ""; fTagMode.value="AND"; refreshAllForNamespace(collectionSelect.value); };

    // Actions
    btnReindex.onclick = async () => {
      const out = await postJSON(api("/admin/reindex"), { namespace: collectionSelect.value });
      log(actionsLog, out);
    };
    btnVacuum.onclick = async () => {
      const out = await postJSON(api("/admin/vacuum"), { namespace: collectionSelect.value, dry_run: true });
      log(actionsLog, out);
    };
    btnExport.onclick = async () => {
      const out = await postJSON(api("/admin/export"), { namespace: collectionSelect.value });
      log(actionsLog, out);
      if (out?.json?.url) window.open(out.json.url, "_blank");
    };
    btnDeleteDoc.onclick = async () => {
      const id = delDocId.value.trim();
      if (!id) return log(actionsLog, "Enter a doc_id first.");
      const url = api(`/docs/${encodeURIComponent(id)}?namespace=${encodeURIComponent(collectionSelect.value)}`);
      const res = await fetch(url, { method: "DELETE" });
      const text = await res.text(); let json; try { json = JSON.parse(text); } catch { json = { raw: text }; }
      log(actionsLog, { ok: res.ok, status: res.status, json });
      refreshAllForNamespace(collectionSelect.value);
    };
    btnTestQuery.onclick = async () => {
      // Uses current filters to build a short “focused” query
      const ns = collectionSelect.value;
      const filterObj = {};
      const tagsCsv = fTags.value.trim();
      if (tagsCsv) filterObj.tags = tagsCsv.split(",").map(s => s.trim()).filter(Boolean);
      if (fMime.value) filterObj.mime = fMime.value;
      if (fFrom.value || fTo.value) filterObj.date = { from: fFrom.value || undefined, to: fTo.value || undefined };
      const body = {
        namespace: ns,
        query: (fQ.value || "Summarize key points from filtered documents.").trim(),
        filters: filterObj,
        retrieval: { hybrid: true, top_k: 12, mmr_lambda: 0.4 }
      };
      const out = await postJSON(api("/query"), body);
      log(actionsLog, out);
    };
  </script>
  <!-- Optional: set LIGHTRAG_API_BASE at runtime -->
  <script>
    // If you deploy this behind a different domain than the API, set window.LIGHTRAG_API_BASE here.
    // Example: window.LIGHTRAG_API_BASE = "https://your-lightrag.onrender.com";
  </script>
</body>
</html>
